---
title: 大屏搭离线部署手册2.0
date: 2019-06-20 22:24:32
tags: 
- 大屏搭
---

# 本文介绍在Linux系统下离线部署大屏搭

## 1. 环境准备

`Centos 7`及以上 （`Centos 6`少很多依赖包，不要用这个）

安装JDK1.8

## 2. mongdb

1. 上传该文件到服务器`/udatav-online/tools/mongodb-linux-x8664-rhel70-3.4.9.tgz`

2. 解压 `tar -xvf mongodb-linux-x8664-rhel70-3.4.9.tgz`

3. 在解压之后的文件夹中创建数据目录和日志目录 `mkdir data` `mkdir log`

4. 添加配置文件mongodb.conf（启动时用配置文件启动） 
    4.1 创建配置文件 `vim mongodb.conf`

    4.2 编辑配置文件，键入 `i` 进行输入，完成后输入 `:wq`  保存
    ``` 
    dbpath=/udatav/mongodb/data  #data目录路径，表示数据库文件存放的位置
	logpath=/udatav/mongodb/log/mongo.log #log目录路径，表示日志文件存放的路径
	logappend=true #表示以追加的方式写日志文件
    ```

5. 启动mongodb
    5.1 进入bin目录 `cd /udatav/mongodb/bin`

    5.2 执行配置文件 `./mongod --config /udatav/mongodb/mongodb.conf --fork` 中间部分为mongodb.conf所在路径

6. 添加用户认证

    6.1 登录mongodb 进入bin目录，执行`./mongo` (此时会出现一个小箭头，可以输入命令)

    6.2 添加用户认证

    ```sql
    use admin;
    db.createUser( {
            user: "root",
            pwd: "udatav123",
            roles: [ {role: "root",db: "admin" } ]
    });

    db.createUser( {
            user: "admin",
            pwd: "udatav123",
            roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
    });

    use udatav;
    db.createUser( {
            user: "udatav",
            pwd: "udatav123",
            roles: [{ role: "readWrite", db: "udatav"}]
    });
    ```

    6.3 添加完成后退出

      6.3.1 `exit;`

      6.3.2 `ps -ef|grep mongo`

      6.3.3 `kill -9 mongo进程`
    
    6.4 修改配置文件
    
       6.4.1 `vim mongodb.conf`
        
       6.4.2 添加 `auth=true #授权认证`
        
       6.4.3 启动mongod，参照步骤5：进入bin目录 `cd /udatav/mongodb/bin`，执行配置文件 `./mongod --config /udatav/mongodb/mongodb.conf --fork`

    6.5 验证用户是否添加成功
    
       6.5.1 登录mongodb 进入bin目录，执行`./mongo`
        
       6.5.2 
     
			use admin;
                db.auth("root","udatav123");
                db.auth("admin","udatav123");
            use udatav;
                db.auth("udatav","udatav123");

            显示1则为成功
 

7. 导入数据

    7.1 上传`udatav-online/data`文件夹中`.json`文件
    
    7.2 `cd /mongodb/bin`
    
    7.3 执行导入json文件
    
    ```
    
    ./mongoimport -u udatav -p udatav123 -d udatav -c USER /udatav/mongodb/jsondata/USER.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c USER_DATABASE /udatav/mongodb/jsondata/USER_DATABASE.json

    
    ./mongoimport -u udatav -p udatav123 -d udatav -c SCENE /udatav/mongodb/jsondata/SCENE.json

    
    ./mongoimport -u udatav -p udatav123 -d udatav -c SCENE_TEMPLATE /udatav/mongodb/jsondata/SCENE_TEMPLATE.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c PROP /udatav/mongodb/jsondata/PROP.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c IMAGES /udatav/mongodb/jsondata/IMAGES.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c ELOPTION /udatav/mongodb/jsondata/ELOPTION.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c COMPONENT /udatav/mongodb/jsondata/COMPONENT.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c COMPONENT_TEMPLATE /udatav/mongodb/jsondata/COMPONENT_TEMPLATE.json


    ./mongoimport -u udatav -p udatav123 -d udatav -c COMP_ASSEMBLY /udatav/mongodb/jsondata/COMP_ASSEMBLY.json

    ./mongoimport -u udatav -p udatav123 -d udatav -c ACCESS_STATISTICS /udatav/mongodb/jsondata/ACCESS_STATISTICS.json
   
    ```
    7.4 重复该步骤将其他的数据导入

## 3. nginx

1. 安装nginx

   <mark>注意：安装前请确保服务器上已安装GCC与G++
	检查方法：g++ --version，可以查询出GCC与G++版本则表示服务器上已安装GCC与G++，如果提示command not found，则表示未安装GCC与G++，需要先安装GCC与G++后再安装nginx
	可以通过两种方式安装gcc与g++
        a.服务器可以联网时，直接运行下面命令安装；
            yum -y install gcc-c++
        b.服务器不能联网时，可以通过配置本地yum源的方式安装gcc(此方法只适用于centos与redhat，suse操作系统请自行查询配置方法)
    </mark>

    b方法详细如下（未验证，有错误请指出）

    ```c++
        在Linux系统中创建两个目录，一个是用来存放ISO文件，一个是用来挂载该ISO文件，如下：
        $mkdir /root/iso;
        $mkdir /root/repo;
        把Linux安装文件ISO文件放置到iso目录下，然后用mount命令把安装文件挂载到repo目录
        $mount -t iso9660 -o loop /root/iso/RHEL5.5-Server-20100322.0-x86_64-DVD.iso /root/repo
        测试是否挂载成功
        $df -h
        在/etc/yum.repos.d目录下创建一个新文件，文件后缀为repo
        $vi iso.repo
        在iso.repo中输入如下内容
        [Server]
        name=RHiso
        baseurl=file:///root/repo/Server
        enable=1
        gpcheck=0
        简单说明：
        baseurl:file://表示本地，/root/repo是我们挂载iso镜像的目录，Server是iso镜像中保存rpm包的目录，我们要安装的GCC包都在里面
        enable=1:表示启动
        gpcheck=0:表示不需要gp验证
        验证和安装，可以使用
        $system-config-packages
        或者可以使用
        $yum -y install gcc-c++ 
    ```

    1.1 安装nginx

    上传`/udatav-online/tools/nginx`目录，进入`nginx`目录，执行`./install_nginx_linux.sh`

    1.2 检查nginx安装是否成功

    执行 `/usr/local/nginx/sbin/nginx`启动`nginx`，执行启动命令后不报错，输入`ps -ef | grep `查看存在nginx进程，表示安装成功。

    1.3 修改配置文件

    修改`/usr/local/nginx/conf/nginx.conf`,参考标准请看`/udatav-online/tools/nginx-demo.conf`

    1.4 重启nginx

    `/usr/local/nginx/sbin/nginx -s reload`

## 4. 前端应用

将`/udatav-online/modules/chart.zip`上传到服务器解压`unzip chart.zip`，放入`nginx/html`路径下

（即 chart解压后的文件：chart文件夹和index.html放在安装nginx的html目录下）

## 5. 后端应用

1. 解压 

    将`/udatav-online/modules/udatav-0.0.1-SNAPSHOT-deploy.tar`上传服务器解压`tar -xvf udatav-0.0.1-SNAPSHOT-deploy.tar`

    将`udatav-localtemp.zip`解压，放入服务器某个路径下（此为下载的安装包文件命名）

2. 修改配置文件，进入`conf`文件夹

    2.1 修改application-register.properties文件

    ```
    vi application-register.properties
    修改里面的ip地址为服务器地址
    ```

    2.2 修改application-privder.properties

    ```shell
    vi application-privder.properties
    修改ip地址和mongodb的连接
    修改单机版资源包路径
    ```

    2.3 修改application-consumer.properties

    ```shell
    vi application-consumer.properties
    修改ip地址和mongodb的连接
    修改单机版资源包路径
    ```
3. 启动服务

    3.1 `cd udatav-0.0.1-SNAPSHOT/bin`

    3.2 `chmod -R 777 *.sh`

    3.3 `./restart.sh`

    3.4 `ps -ef | grep udatav`查看udatav进程

## 其他，可能会出现的问题

1. 启动nginx报错：

>[emerg] 10352#3232: unknown directive "" in usr/local/nginx/conf/nginx.conf:3

原因：conf文件被记事本编辑过，保存成了含[UTF8-BOM]

解决方法：使用`nodepad++`等其它非记事本 另存为 `UTF-8` 不含BOM 的文件就可以了。

2. 启动nginx报错：

>unkonwn directive " upstream udatavServer" in usr/local/nginx/conf/nginx.conf:46

原因：该部分代码书写不规范

解决方法：重新手敲这部分代码

3. 执行shell脚本，报错:

>/bin/bash^M: 坏的解释器: 没有那个文件或目录

原因：是因为该文件在windows系统上打开过，关闭后其中的空格符号和Linux的不同，导致这个报错，我们可以通过sed命令与正则的配合将文件中的空格符号替换成linux的空格

解决方法：
`sed -i 's/\r$//' xxx.sh`

4. mongodb设置的密码中含有`@`和`:`符号时，注意后端修改配置文件时要将这两者转为16进制进行URL编码

可能出现的报错信息：

```java
java.lang.IllegalArgumentException: The connection string contains invalid user information. If the username or password contains a colon (:) or an at-sign (@) then it must be urlencoded
	at com.mongodb.ConnectionString.<init>(ConnectionString.java:262)
	at com.mongodb.MongoClientURI.<init>(MongoClientURI.java:201)

```

解决办法：

对`@`使用16进制进行URL编码：`%40`

对`:`使用16进制进行URL编码：`%3A`

如：`uinnova@123` 改写为 `uinnova%40123`

5. 一直提示TOKEN过期，重新登录

原因： 

(1)后端问题，比如第四个问题中数据库导致的问题
   
(2)nginx问题，检查nginx是否请求转发，没有postman的情况下利用curl命令发送请求

解决方法：

查看`nginx/conf/access.log` `nginx/conf/error.log`

查看 `udatav/udatav-0.0.1-SNAPSHOT/consumer.log、provider.log、register.log`


6. 报错及原因：

![](https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g490zwsyzyj30hj08h74g.jpg)

解决方法：修改application-consumer.properties

```
# 配置监控统计拦截的filters，去掉后监控界面sql无法统计，'wall'用于防火墙（防止SQL注入）,删掉wall可以执行sybase的查询语句

spring.datasource.filters=stat,wall,log4j  
```


## tips

1. 清空日志:   `>file.log`

